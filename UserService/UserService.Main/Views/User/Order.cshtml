@model OrdersViewModel

@{
    ViewBag.Title = "Orders";
    Layout = "_Layout";
}

<h2>Orders</h2>

<table id="ordersTable" class="table table-striped table-bordered table-hover text-center" style="width: 100%;">
    <thead>
    <tr>
        <th>OrderId</th>
        <th>Status</th>
        <th>Price</th>
        <th>Comment</th>
        <th>Client Address</th>
        <th>Courier Number</th>
        <th>Client Number</th>
        <th>Cheque</th>
        <th>Basket</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var order in Model.Orders)
    {
        <tr>
            <td style="vertical-align: middle;">@order.Id</td>
            <td style="vertical-align: middle;">@order.Status</td>
            <td style="vertical-align: middle;">@order.Price</td>
            <td style="vertical-align: middle;">@order.Comment</td>
            <td style="vertical-align: middle;">@order.ClientAddress</td>
            <td style="vertical-align: middle;">@order.CourierNumber</td>
            <td style="vertical-align: middle;">@order.ClientNumber</td>
            <td style="vertical-align: middle;">@order.Cheque</td>
            <td style="vertical-align: middle;">
                @foreach (var item in order.Basket)
                {
                    <li>@item.ProductId - @item.Amount - @item.Price</li>
                }
            </td>
            <td style="vertical-align: middle;">
                <button class="btn btn-secondary" onclick="cancelOrder('@order.Id')">Cancel</button>
                <input type="text" id="reason-@order.Id" placeholder="Причина отмены">
            </td>
        </tr>
    }
    </tbody>
</table>

<script>
    $(document).ready(function() {
        $.ajax({
            url: "http://localhost/your-script.php", // Замените на URL вашего скрипта
            type: "GET",
            dataType: "json",
            success: function(orders) {
                const tableBody = $("#ordersTable tbody");
                orders.forEach(order => {
                    let basketHtml = order.Basket.map(item => `<li>${item.ProductId} - ${item.Amount} - ${item.Price}</li>`).join('');
                    tableBody.append(`
              <tr>
                <td>${order.Id}</td>
                <td>${order.Status}</td>
                <td>${order.Price}</td>
                <td>${order.Comment}</td>
                <td>${order.ClientAddress}</td>
                <td>${order.CourierNumber}</td>
                <td>${order.ClientNumber}</td>
                <td>${order.Cheque}</td>
                <td><ul>${basketHtml}</ul></td>
                <td>
                  <button class="btn btn-secondary" onclick="cancelOrder('${order.Id}')">Cancel</button>
                  <input type="text" id="reason-${order.Id}" placeholder="Причина отмены">
                </td>
              </tr>
            `);
                });
            },
            error: function(error) {
                console.error("Ошибка при получении данных:", error);
            }
        });
    });
    
    async function cancelOrder(orderId) {
        let confirmation = confirm("Вы уверены, что хотите отменить заказ " + orderId + "?");
        if (confirmation) {
        let reason = document.getElementById("reason-" + orderId).value;
        try {
            const response = await $.ajax({
                url: "http://localhost:5106/orders/client/cancel/" + orderId,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify({ reasonOfCanceled: reason })
            });
            console.log(response);
            location.reload();
        } catch (error) {
            console.error(error);
            alert("Ошибка при отмене заказа.");
        }
        } 
    }

</script>